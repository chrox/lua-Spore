<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module Spore</title>
    <link rel="stylesheet" href="doc.css" type="text/css"/>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta http-equiv="Author" content="Fran&ccedil;ois Perrad"/>
  <meta http-equiv="Language" content="en"/>
  <meta http-equiv="Description" content="Module Spore"/>
  <meta http-equiv="Keywords" content="lua, SPORE, ReST, ReSTapi, ReSTful, new_from_spec, new_from_string, enable, enable_if, reset_middlewares, methname_modifier, oauth"/>
</head>

<body>

<div id="container">

<div id="product">
  <div id="product_logo">
    <a href="http://www.lua.org">
      <img alt="Lua" src="http://www.andreas-rozek.de/Lua/Lua-Logo_128x128.png"/>
    </a>
  </div>
  <div id="product_name"><big><strong>lua-Spore</strong></big></div>
  <div id="product_description">a generic ReST client</div>
</div> <!-- id="product" -->

<div id="main">

<div id="navigation">
<h1>Spore</h1>
  <ul>
    <li><a href="index.html">Home</a>
      <ul>
        <li><a href="index.html#overview">Overview</a></li>
        <li><a href="index.html#references">References</a></li>
        <li><a href="index.html#status">Status</a></li>
        <li><a href="index.html#download">Download</a></li>
        <li><a href="index.html#installation">Installation</a></li>
        <li><a href="index.html#test">Test</a></li>
        <li><a href="index.html#license">License</a></li>
      </ul>
    </li>
    <li><strong>module <code>Spore</code></strong>
      <ul>
        <li><a href="spore.html#reference">Reference</a></li>
        <li><a href="spore.html#examples">Examples</a></li>
      </ul>
    </li>
    <li><a href="middleware.html">module <code>S.Middleware</code></a>
      <ul>
        <li><a href="middleware.html#aws">Auth.AWS</a></li>
        <li><a href="middleware.html#basic">Auth.Basic</a></li>
        <li><a href="middleware.html#bearer">Auth.Bearer</a></li>
        <li><a href="middleware.html#publica">Auth.DataPublica</a></li>
        <li><a href="middleware.html#digest">Auth.Digest</a></li>
        <li><a href="middleware.html#oauth">Auth.OAuth</a></li>
        <li><a href="middleware.html#json">Format.JSON</a></li>
        <li><a href="middleware.html#xml">Format.XML</a></li>
        <li><a href="middleware.html#yaml">Format.YAML</a></li>
        <li><a href="middleware.html#default">Parameter.Default</a></li>
        <li><a href="middleware.html#force">Parameter.Force</a></li>
        <li><a href="middleware.html#proxy">Proxy.Basic</a></li>
        <li><a href="middleware.html#cache">Cache</a></li>
        <li><a href="middleware.html#dnt">DoNotTrack</a></li>
        <li><a href="middleware.html#logging">Logging</a></li>
        <li><a href="middleware.html#mock">Mock</a></li>
        <li><a href="middleware.html#runtime">Runtime</a></li>
        <li><a href="middleware.html#redirection">Redirection</a></li>
        <li><a href="middleware.html#useragent">UserAgent</a></li>
      </ul>
    </li>
    <li><a href="discovery.html">module <code>S.GoogleDiscovery</code></a>
      <ul>
        <li><a href="discovery.html#reference">Reference</a></li>
        <li><a href="discovery.html#examples">Examples</a></li>
      </ul>
    </li>
    <li><a href="wadl.html">module <code>S.WADL</code></a>
      <ul>
        <li><a href="wadl.html#reference">Reference</a></li>
        <li><a href="wadl.html#examples">Examples</a></li>
      </ul>
    </li>
    <li><a href="http://fperrad.github.io/lua-Spore/">Project</a>
      <ul>
        <li><a href="http://github.com/fperrad/lua-Spore/">Git</a></li>
        <li><script type="text/javascript" src="http://www.ohloh.net/p/485769/widgets/project_thin_badge.js"></script></li>
      </ul>
    </li>
  </ul>
</div> <!-- id="navigation" -->

<div id="content">

<h2><a name="reference"></a>Reference</h2>

<h3>Global Functions</h3>

<h4><code>new_from_spec( desc1, [desc2, ...][, { options }] )</code></h4>

<p>Instanciate a ReST client from one or more descriptions defined by a filename or an URL.</p>

<p>The optional table <code>options</code> allows to overwrite some parameters of the description: </p>

<ul>
  <li><code>authentication</code>,</li>
  <li><code>base_url</code>,</li>
  <li><code>expected_status</code>,</li>
  <li><code>formats</code>,</li>
  <li><code>unattended_params</code></li>
</ul>

<pre class="example">
local client = require 'Spore'.new_from_spec 'github.json'
</pre>

<h4><code>new_from_string( desc1, [desc2, ...][, { options }] )</code></h4>

<p>Same as <code>new_from_spec</code>, but works with <em>inline</em> description.</p>

<pre class="example">
local client = require 'Spore'.new_from_string [[
{
    "base_url" : "http://smolder.parrot.org",
    "name" : "smolder",
    "methods" : {
        "upload" : {
            "path" : "/app/projects/process_add_report/:project_id",
            "method" : "POST",
            "form-data" : {
                "architecture"  : ":architecture",
                "platform"      : ":platform",
                "tags"          : ":tags",
                "comments"      : ":comments",
                "username"      : ":username",
                "password"      : ":password",
                "project_id"    : ":project_id",
                "report_file"   : "@:report_file"
            },
            "required_params" : [
                "project_id",
                "report_file",
                "username",
                "password"
            ],
            "optional_params" : [
                "architecture",
                "platform",
                "tags",
                "comments"
            ],
            "expected_status" : [ 302 ]
        }
    }
}
]]

local r = client:upload{
    tags         = 'linux, i686-linux-gnu-thread-multi, lua, 5.1',
    comments     = 'experiment with lua-Spore',
    username     = 'parrot-autobot',
    password     = 'qa_rocks',
    project_id   = 7,
    report_file  = 'test_lua51.tar.gz',
}
print(r.body)
</pre>

<h4><code>new_from_lua( desc [, { options }] )</code></h4>

<p>Instanciate a ReST client from a Lua table.</p>

<p>The optional table <code>options</code> allows to overwrite some parameters of the description
(see <code>new_from_spec</code>).</p>

<pre class="example">
local client = require 'Spore'.new_from_lua{
    base_url = 'http://services.org/restapi/',
    methods = {
        get_info = {
            path = '/show',
            method = 'GET',
        },
        get_user_info = {
            path = '/show',
            method = 'GET',
            required_params = {
                'user',
            },
        },
    },
}

local r = client:get_user_info{ user = 'John' }
</pre>

<h3>Instance Methods</h3>

<p>These methods are inherited from <code>Spore.Core</code>
(so, do not use these name in API description).</p>

<h4><code>enable( middleware [, args] )</code></h4>

<p>Enable a middleware with the optional table <code>args</code>.</p>

<h4><code>enable_if( cond, middleware [, args] )</code></h4>

<p>Enable a conditional middleware.</p>

<pre class="example">
client:enable_if(function (req)
                     return req.env.spore.caller ~= 'get_attachment'
                 end,
                 'Format.JSON')
</pre>

<h4><code>reset_middlewares()</code></h4>

<p>Removes all middlewares.</p>

<h4><code>http_request( env )</code></h4>

<p>Never directly called.</p>

<h3>Global Variables</h3>

<p>These variables allow to do some configuration.</p>

<h4><code>debug</code></h4>

<p>The default value is <code>nil</code>.</p>

<pre class="example">
require 'Spore'.debug = io.stdout
</pre>

<h4><code>errors</code></h4>

<p>The default value is <code>io.stderr</code>.</p>

<h4><code>methname_modifier</code></h4>

<p>The default value is <code>nil</code>.</p>

<p>This function allows to alter the name of the method during the instanciation.</p>

<pre class="example">
require 'Spore'.methname_modifier = function (name)
    local lowerCamelCase = name:gsub('_(%w)', function (c) return c:upper() end)
    return lowerCamelCase
end
</pre>


<h2><a name="examples"></a>Examples</h2>

<h3>GitHub via http</h3>

<pre class="example">
local Spore = require 'Spore'

local github = Spore.new_from_spec 'https://raw.github.com/SPORE/api-description/master/services/github.json'
github:enable 'Format.JSON'
github:enable('Auth.Basic', {
    username = 'schacon/token',
    password = '6ef8395fecf207165f1a82178ae1b984',
})
local res = github:get_info{format = 'json', username = 'schacon'}
print(res.status)               --> 200
print(res.headers['x-runtime']) --> 126ms
print(res.body.user.name)       --> Scott Chacon
</pre>

<h3>GitHub via https</h3>

<p>The HTTPS protocol requires <a href="http://github.com/brunoos/luasec">LuaSec</a>.</p>

<pre class="example">
local Spore = require 'Spore'

local github = Spore.new_from_spec('https://raw.github.com/SPORE/api-description/master/services/github.json', {
    base_url = "https://github.com/api/v2/",
})
github:enable 'Format.JSON'
local res = github:get_info{format = 'json', username = 'schacon'}
print(res.status)               --> 200
print(res.headers['x-runtime']) --> 126ms
print(res.body.user.name)       --> Scott Chacon
</pre>

<h3>CouchDB</h3>

<p>This example comes from the book
<a href="http://guide.couchdb.org/draft/api.html">CouchDB, The Definitif Guide</a>.</p>

<pre class="example">
local base = 'https://raw.github.com/SPORE/api-description/master/apps/couchdb/'
local couchdb = require 'Spore'.new_from_spec(
    base .. 'server.json',
    base .. 'database.json',
    base .. 'document.json',
    base .. 'design.json',
    { base_url = 'http://127.0.0.1:5984/' })
couchdb:enable_if(function (req) return req.env.spore.caller ~= 'get_attachment' end, 'Format.JSON')

local r = couchdb:get_root()
print(r.body.couchdb)
print(r.body.version)

local r = couchdb:create_db{ db = 'albums' }
assert(r.body.ok)
local r = couchdb:create_db{ db = 'albums' }
print("error", r.body.error)
print("reason", r.body.reason)

local r = couchdb:add_document{
    db = 'albums',
    id = '6e1295ed6c29495e54cc05947f18c8af',
    payload = {
        title = "There is Nothing Left to Lose",
        artist = "Foo Fighters",
    },
}
assert(r.body.ok)
print("id", r.body.id)
print("rev", r.body.rev)

local r = couchdb:get_uuids()
assert(#r.body.uuids == 1)
for i, v in ipairs(r.body.uuids) do print("uuid",i, v) end

local r = couchdb:get_document{
    db = 'albums',
    id = '6e1295ed6c29495e54cc05947f18c8af',
}
print("_id", r.body._id)
print("_rev", r.body._rev)
print("title", r.body.title)
print("artist", r.body.artist)
local rev1 = r.body._rev

local r = couchdb:add_document{
    db = 'albums',
    id = '6e1295ed6c29495e54cc05947f18c8af',
    payload = {
        title = "There is Nothing Left to Lose",
        artist = "Foo Fighters",
        year = 1997,
    },
}
print("error", r.body.error)
print("reason", r.body.reason)

local r = couchdb:add_document{
    db = 'albums',
    id = '6e1295ed6c29495e54cc05947f18c8af',
    payload = {
        _rev = rev1,
        title = "There is Nothing Left to Lose",
        artist = "Foo Fighters",
        year = 1997,
    },
}
assert(r.body.ok)
print("id", r.body.id)
print("rev", r.body.rev)
local rev2 = r.body.rev

local r = couchdb:add_document{
    db = 'albums',
    id = '70b50bfa0a4b3aed1f8aff9e92dc16a0',
    payload = {
        title = "Blackened Sky",
        artist = "Biffy Clyro",
        year = 2002,
    },
}
print("Location", r.headers['location'])
assert(r.body.ok)
print("id", r.body.id)
print("rev", r.body.rev)

local slurp = require 'Spore.Protocols'.slurp
local r = couchdb:add_attachment{
    db = 'albums',
    id = '6e1295ed6c29495e54cc05947f18c8af',
    rev = rev2,
    file = 'api.png',
    content_type = 'image/png',
    payload = slurp'api.png',
}
assert(r.body.ok)
print("id", r.body.id)
print("rev", r.body.rev)

local r = couchdb:get_attachment{
    db = 'albums',
    id = '6e1295ed6c29495e54cc05947f18c8af',
    file = 'api.png',
}
print("Content-Type", r.headers['content-type'])
print("Content-Length", r.headers['content-length'])

local r = couchdb:get_document{
    db = 'albums',
    id = '6e1295ed6c29495e54cc05947f18c8af',
}
print("_id", r.body._id)
print("_rev", r.body._rev)
print("title", r.body.title)
print("artist", r.body.artist)
for k, v in pairs(r.body._attachments) do
    print(k)
    for kk, vv in pairs(v) do print(kk, vv) end
end
</pre>

<h3>with Google &amp; OAuth 1.0</h3>

<p>This example uses the service Google URL Shortener.</p>

<pre class="example">
local url = require 'socket.url'
local Spore = require 'Spore'
--Spore.debug = io.stdout

local function get_google_keys (scope, keys)
    local oauth = require 'Spore'.new_from_spec 'https://raw.github.com/SPORE/api-description/master/services/googleoauth.json'
    oauth:enable('Auth.OAuth', keys)
    local r1 = oauth:get_request_token{
        scope = scope,
    }
    print("request", r1.body)
    for k, v in r1.body:gmatch'([^&amp;=]+)=([^&amp;=]*)&amp;?' do keys[k] = url.unescape(v) end

    local r2 = oauth:authorize_token{ oauth_token = keys.oauth_token }
    print("authorize", r2.status, r2.headers.location)

    os.execute("x-www-browser " .. r2.headers.location)

    print "enter oauth_verifier:"
    local input = io.stdin:read('*l')
    print("oauth_verifier=]" .. input .. "[")
    keys.oauth_verifier = input

    local r3 = oauth:get_access_token()
    print("access", r3.body)
    for k, v in r3.body:gmatch'([^&amp;=]+)=([^&amp;=]*)&amp;?' do keys[k] = url.unescape(v) end

    keys.oauth_callback_confirmed = nil
    keys.oauth_verifier = nil
    return keys
end


local client = require 'Spore'.new_from_spec 'https://raw.github.com/SPORE/api-description/master/services/googleshortener.json'
client:enable 'Format.JSON'
client:enable('Auth.OAuth', get_google_keys('https://www.googleapis.com/auth/urlshortener', {
    oauth_consumer_key    = '000000000000.apps.googleusercontent.com',
    oauth_consumer_secret = 'XXXXXXXXXXXXXXXXXXXXXXXX',
}))

local r = client:insert{ payload = { longUrl = 'http://www.google.com/' } }
print(r.body.id, r.body.longUrl)

local r = client:list()
print "\nAUTHORIZED\n"
for k, v in pairs(r.body) do
    print(k, v)
end
</pre>

</div> <!-- id="content" -->

</div> <!-- id="main" -->

<div id="about">
</div> <!-- id="about" -->

</div> <!-- id="container" -->

</body>
</html>
